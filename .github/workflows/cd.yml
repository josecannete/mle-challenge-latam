name: 'Continuous Delivery'

on:
  push:
    branches:
      - feature/deploy

env:
  PROJECT_ID: latam-challenge-448714
  GAR_LOCATION: us-central1
  GAR_REPO: latam-images
  APP: delay-model
  VERTEX_ENDPOINT_ID: 7896596853175615488

jobs:
  deploy:
    # Add 'id-token' with the intended permissions for workload identity federation
    permissions:
      contents: 'read'
      id-token: 'write'

    runs-on: ubuntu-latest
    steps:
        - uses: 'actions/checkout@v4'

        - uses: 'google-github-actions/auth@v2'
          with:
            project_id: '${{ env.PROJECT_ID }}'
            workload_identity_provider: 'projects/831127518569/locations/global/workloadIdentityPools/github/providers/my-repo'

        - uses: 'google-github-actions/setup-gcloud@v2'
          with:
            version: '>= 363.0.0'

        - name: 'Docker auth'
          run: |-
            gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

        - name: 'Build and push container'
          run: |-
            docker build -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.APP }}:${{ github.sha }}" .
            docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.APP }}:${{ github.sha }}"

        - name: 'Upload model'
          run: gcloud ai models upload --region=us-central1 --display-name=${{ env.APP }} --container-image-uri="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.APP }}:${{ github.sha }}" --model-id delay-model --parent-model projects/latam-challenge-448714/locations/us-central1/models/delay-model --version-aliases default

        - name: 'Deploy model'
          run: gcloud ai endpoints deploy-model delay-model-endpoint --project="latam-challenge-448714" --region=us-central1 --model=delay-model --display-name=delay-model-deployed

